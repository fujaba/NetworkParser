// MAJOR VERSION - Manually set
//----------------------
def majorNumber = 4
group = 'de.uniks'
//----------------------

import java.text.SimpleDateFormat

ext{
	if(project.hasProperty('buildAnt')) {
		buildAntCompile.execute()
		buildAnt.execute()
		project.ext.Revisionnumber = Integer.parseInt(ant.Revisionnumber)
		project.ext.Branchname = ant.Branchname
		project.ext.LastCommit = ant.LastCommit
		project.ext.GitTag = Integer.parseInt(ant.GitTag)
	}

	gitVersion = new GITVersion(major: majorNumber,minor: ext.GitTag, revision: ext.Revisionnumber, hash: ext.LastCommit, buildTime: buildTime(), branch: ext.Branchname)
}
version = gitVersion
task printVersion {
	group "Git"
	description "Show Final Version of Repository"
	doLast {
		println gitVersion

		println "Revisionnumber: "	+ project.ext.Revisionnumber
		println "Branchname: " 		+ project.ext.Branchname
		println "LastCommit: "		+ project.ext.LastCommit
		println "GitTag: "			+ project.ext.GitTag
    }
}

// Define a method using a closure as the method body
public class GITVersion {
	// MAJOR VERSION - Manually set
	int major = -1
	int minor = -1
	int revision = -1
	String buildTime
	String hash = ""
	String branch
	String prefix = ""

	String toString() {
		if (System.getenv().BUILD_NUMBER) {
			revision = System.getenv().BUILD_NUMBER as int
		}
		
		if(!isRelease() && !isMaster()) {
			"$major.$minor.$revision${'-SNAPSHOT'}"
		} else {
			"$major.$minor.$revision"
		}
    }
	
	boolean isMaster() {
		return branch.contains("master")
	}
	boolean isRelease() {
		return branch.contains("release")
	}
}

def buildTime() {
	//def df = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'") //you can change it
	def df = new SimpleDateFormat("yyyyMMdd'T'HHmmss") //you can change it
	df.setTimeZone(TimeZone.getTimeZone("UTC"))
	return df.format(new Date())
}
