// MAJOR VERSION - Manually set
//----------------------
def majorNumber = 4
group = 'de.uniks'
//----------------------

import java.text.SimpleDateFormat

ext{
	try{
		buildAntCompile.execute()
		buildAnt.execute()
		project.ext.Revisionnumber = Integer.parseInt(ant.Revisionnumber)
		if (project.hasProperty("branch")) {
			project.ext.Branchname = ant.Branchname + " " + project.get("branch")
		}else {
			project.ext.Branchname = ant.Branchname
		}
		project.ext.LastCommit = ant.LastCommit
		project.ext.GitTag = Integer.parseInt(ant.GitTag)
	}catch(Exception e) {
		println e
		project.ext.Revisionnumber = revisionNumber()
		if (project.hasProperty("branch")) {
			project.ext.Branchname = project.get("branch")
		} else {
			project.ext.Branchname = ""
		}
		project.ext.LastCommit = getGitLastCommit()
		project.ext.GitTag = getGitTag()
	}
	gitVersion = new GITVersion(major: majorNumber,minor: ext.GitTag, revision: ext.Revisionnumber, hash: ext.LastCommit, buildTime: buildTime(), branch: ext.Branchname, latest: project.hasProperty('latest'))
}
version = gitVersion
task printVersion {
	group "Git"
	description "Show Final Version of Repository"
	doLast {
		println gitVersion

		println "Revisionnumber: "	+ project.ext.Revisionnumber
		println "Branchname: " 		+ project.ext.Branchname
		println "LastCommit: "		+ project.ext.LastCommit
		println "GitTag: "			+ project.ext.GitTag
    }
}

// Define a method using a closure as the method body
public class GITVersion {
	// MAJOR VERSION - Manually set
	int major = -1
	int minor = -1
	int revision = -1
	String buildTime
	String hash = ""
	String coverage = ""
	String branch
	String prefix = ""
	boolean latest

	String toString() {
		if (System.getenv().BUILD_NUMBER) {
			revision = System.getenv().BUILD_NUMBER as int
		}
		if(latest) {
			""
		} else if(!isRelease() && !isMaster()) {
			"$major.$minor.$revision${'-SNAPSHOT'}"
		} else {
			"$major.$minor.$revision"
		}
    }
	
	boolean isMaster() {
		return branch.contains("master")
	}
	boolean isRelease() {
		return branch.contains("release")
	}
}

def buildTime() {
	//def df = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'") //you can change it
	def df = new SimpleDateFormat("yyyyMMdd'T'HHmmss") //you can change it
	df.setTimeZone(TimeZone.getTimeZone("UTC"))
	return df.format(new Date())
}

def executeCommand(String[] args) {
	def pb = new ProcessBuilder(args)
	def result = ""
	InputStream is = null
	ByteArrayOutputStream stdout
	try {
		def prs = pb.start()
		is = prs.getInputStream();
		byte[] b = new byte[1024];
		int size = 0;
		stdout = new ByteArrayOutputStream();
		while((size = is.read(b)) != -1){
			stdout.write(b, 0, size);
		}
		result = stdout.toString()
	} catch (Exception e) {
	} finally{
		try {
			if(is != null) is.close();
			if(stdout != null) stdout.close();
		} catch (Exception ex){}
	}
	result
}
def getGitTag() {
	def gittag=0
	def test = [0]
	executeCommand("git", "tag").eachLine {
		try {
			test << (it.trim() as int)
		} catch (Exception ex) {
			// no problem as long as there's another tag with a number
		}
	}
	gittag = test.max()
	gittag
}
def getGitLastCommit() {
	def gittag=""
	executeCommand("git", "log", "--pretty=format:\"%H\"", "-1").eachLine {
		gittag = it.trim()
	}
	gittag
}

def revisionNumber() {
	def count = 0
	executeCommand("git", "log", "--oneline").eachLine {
		count = count + 1
	}
	if( count == 0) {
		count = -1
	}
	count
}
